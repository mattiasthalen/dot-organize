{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/mattiasthalen/hook/manifest-schema-v1.json",
  "title": "HOOK Manifest Schema v1",
  "description": "Schema for HOOK manifest files that declare business concepts, hooks, key sets, and frames.",
  "type": "object",
  "required": ["manifest_version", "schema_version", "metadata", "settings", "frames", "targets"],
  "additionalProperties": false,
  "properties": {
    "manifest_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Version of this manifest (user-controlled, semver format)",
      "examples": ["1.0.0", "2.1.3"]
    },
    "schema_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Version of the manifest schema",
      "examples": ["1.0.0"]
    },
    "metadata": {
      "$ref": "#/$defs/Metadata"
    },
    "settings": {
      "$ref": "#/$defs/Settings"
    },
    "frames": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/Frame"
      },
      "description": "List of frames (at least one required)"
    },
    "concepts": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/Concept"
      },
      "default": [],
      "description": "Optional enrichment definitions for auto-derived concepts"
    },
    "targets": {
      "$ref": "#/$defs/Targets"
    }
  },
  "$defs": {
    "Metadata": {
      "type": "object",
      "required": ["name", "created_at", "updated_at"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable name for the manifest"
        },
        "description": {
          "type": ["string", "null"],
          "description": "Optional description"
        },
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of creation"
        },
        "updated_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of last update"
        }
      }
    },
    "Settings": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "hook_prefix": {
          "type": "string",
          "minLength": 1,
          "default": "_hk__",
          "description": "Prefix for strong hooks"
        },
        "weak_hook_prefix": {
          "type": "string",
          "minLength": 1,
          "default": "_wk__",
          "description": "Prefix for weak hooks"
        },
        "delimiter": {
          "type": "string",
          "minLength": 1,
          "maxLength": 1,
          "default": "|",
          "description": "Delimiter separating key set from business key"
        }
      }
    },
    "Frame": {
      "type": "object",
      "required": ["name", "source", "hooks"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*\\.[a-z][a-z0-9_]*$",
          "description": "Frame name in lower_snake_case (schema.table format)",
          "examples": ["frame.customer", "psa.order_header"]
        },
        "source": {
          "type": "string",
          "minLength": 1,
          "description": "Source table reference",
          "examples": ["psa.customer", "staging.orders"]
        },
        "description": {
          "type": ["string", "null"],
          "description": "Optional description"
        },
        "hooks": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/Hook"
          },
          "description": "List of hooks (at least one required)"
        }
      }
    },
    "Hook": {
      "type": "object",
      "required": ["name", "role", "concept", "source", "expr_sql"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^_(hk|wk)__[a-z][a-z0-9_]*(__[a-z][a-z0-9_]*)?$",
          "description": "Hook column name",
          "examples": ["_hk__customer", "_hk__employee__manager", "_wk__ref__genre"]
        },
        "role": {
          "type": "string",
          "enum": ["primary", "foreign"],
          "description": "Hook role: 'primary' defines frame grain, 'foreign' references other concept"
        },
        "concept": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$",
          "description": "Business concept in lower_snake_case",
          "examples": ["customer", "order", "employee"]
        },
        "qualifier": {
          "type": ["string", "null"],
          "pattern": "^[a-z][a-z0-9_]*$",
          "description": "Optional qualifier suffix in lower_snake_case",
          "examples": ["manager", "billing", "shipping"]
        },
        "source": {
          "type": "string",
          "pattern": "^[A-Z][A-Z0-9_]*$",
          "description": "Source system in UPPER_SNAKE_CASE",
          "examples": ["CRM", "SAP", "SAP_FIN"]
        },
        "tenant": {
          "type": ["string", "null"],
          "pattern": "^[A-Z][A-Z0-9_]*$",
          "description": "Optional tenant in UPPER_SNAKE_CASE",
          "examples": ["AU", "US", "EU_WEST"]
        },
        "expr_sql": {
          "type": "string",
          "minLength": 1,
          "description": "SQL expression for business key (pure expression, no SELECT/JOIN)",
          "examples": ["customer_id", "order_id || '-' || line_number", "UPPER(TRIM(code))"]
        },
        "treatment": {
          "type": ["string", "null"],
          "pattern": "^[A-Z]+(:[^|]+)?(\\|[A-Z]+(:[^|]+)?)*$",
          "description": "Optional transformation chain (e.g., 'TRIM|UPPER|LPAD:6:0')",
          "examples": ["TRIM", "UPPER", "LPAD:6:0", "TRIM|UPPER|LPAD:6:0"]
        }
      }
    },
    "Concept": {
      "type": "object",
      "required": ["name", "description"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$",
          "description": "Concept name (must match a concept used in frames)",
          "examples": ["customer", "order", "product"]
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "1-2 sentence definition"
        },
        "examples": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": [],
          "description": "Real-world examples"
        },
        "is_weak": {
          "type": "boolean",
          "default": false,
          "description": "True for reference/time/system concepts"
        }
      }
    },
    "Targets": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "hook_sql": {
          "type": "object",
          "description": "Reserved for HOOK SQL generator (v1: allowed but ignored)"
        },
        "uss_sql": {
          "type": "object",
          "description": "Reserved for USS SQL generator (v1: allowed but ignored)"
        },
        "qlik": {
          "type": "object",
          "description": "Reserved for Qlik generator (v1: allowed but ignored)"
        }
      }
    }
  }
}
